<ion-content [fullscreen]="true">
  <ion-header collapse="condense">
    <ion-toolbar>
      <ion-buttons slot="start">
        <ion-back-button defaultHref="/home" text=""></ion-back-button>
      </ion-buttons>
      <ion-title size="medium">Profile</ion-title>
    </ion-toolbar>
  </ion-header>
  <!-- Photo de couverture -->
  <div class="cover-photo"></div>
  <!-- Photo de profil -->
  <div class="profile-container">
    <div class="profile-pic">
      {{ initials }}
    </div>
  </div>
  <!-- Informations personnelles -->
  <div class="profile-info">
    <p class="name">{{ name }}</p>
    <p class="role" *ngIf="role === 'doctor'">Doctor</p>
    <p class="role" *ngIf="role === 'patient'">Patient</p>
  </div>
  <!-- Patient Appointments -->
  <div *ngIf="role === 'patient'">
    <!-- Upcoming Appointments -->
    <div class="calendar-container">
      <p class="calendar-title">Upcoming Appointments</p>
      <ion-list>
        <ng-container *ngIf="upcomingAppointments.length > 0; else noUpcoming">
          <ng-container *ngFor="let appointment of upcomingAppointments">
            <ion-item class="calendar-event" [ngClass]="getStatusClass(appointment.status)">
              <ion-label>
                <p>
                  Doctor: {{ appointment.doctor_name }}<br>
                  Day: {{ getDate(appointment.dateTime) }}<br>
                  Time: {{ getTime(appointment.dateTime) }}<br>
                  Status: {{ appointment.status }}
                </p>
              </ion-label>
            </ion-item>
          </ng-container>
        </ng-container>
        <ng-template #noUpcoming>
          <ion-item lines="none">
            <ion-label class="no-appointments">No upcoming appointments</ion-label>
          </ion-item>
        </ng-template>
      </ion-list>
    </div>
    <!-- Previous Consultations -->
    <div class="calendar-container">
      <p class="calendar-title">Previous Consultations</p>
      <ion-list>
        <div *ngIf="isLoadingConsultations">
          <ion-spinner></ion-spinner> Loading consultations...
        </div>
        <div *ngIf="consultationsError" class="error-message">
          {{ consultationsError }}
          <ion-button fill="clear" (click)="getConsultations()">Retry</ion-button>
        </div>
        <ng-container *ngIf="consultations.length > 0 && !isLoadingConsultations && !consultationsError; else noOld">
          <ng-container *ngFor="let consultation of consultations">
            <ion-item class="calendar-event" (click)="openConsultationModal(consultation)">
              <ion-label>
                <p>
                  Doctor: {{ consultation.doctor_name }}<br>
                  Day: {{ getDate(consultation.dateTime) }}<br>
                  Time: {{ getTime(consultation.dateTime) }}<br>
                </p>
              </ion-label>
            </ion-item>
          </ng-container>
        </ng-container>
        <ng-template #noOld>
          <ion-item lines="none">
            <ion-label class="no-appointments">No previous consultations</ion-label>
          </ion-item>
        </ng-template>
      </ion-list>
    </div>
  </div>

  <!-- Modal for Consultation Details -->
  <ion-modal [isOpen]="isModalOpen">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Consultation Details</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="setOpen(false)">Close</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content class="ion-padding">
        <div *ngIf="selectedConsultation">
          <p><strong>Doctor:</strong> {{ selectedConsultation.doctor_name }}</p>
          <p><strong>Patient:</strong> {{ selectedConsultation.patient_name }}</p>
          <p><strong>Day:</strong> {{ getDate(selectedConsultation.dateTime) }}</p>
          <p><strong>Time:</strong> {{ getTime(selectedConsultation.dateTime) }}</p>
          <p><strong>Details:</strong> {{ selectedConsultation.details || 'No details provided.' }}</p>
        </div>
        <div *ngIf="!selectedConsultation">
          <p>No consultation selected.</p>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>
    <!--Medical File section-->
    <div class="medical-file-container">
      <ion-item *ngIf="role === 'patient'">
        <ion-button expand="block" (click)="downloadMedicalFile()">
          Download Medical File
        </ion-button>
      </ion-item>
    </div>
  <!-- Doctor Appointments -->
  <div *ngIf="role === 'doctor'" class="calendar-container">
    <p class="calendar-title">Appointments Calendar</p>
    <ion-datetime presentation="date" value="{{date}}" [highlightedDates]="highlightedDates" class="force-light-mode" (ionChange)="onDateChange($event)" firstDayOfWeek="1" locale="en-US">
      <!-- Dummy comment to force Angular to recognize this as a non-self-closing tag -->
    </ion-datetime>
    <ion-content class="ion-padding">
      <ion-modal [isOpen]="isModalOpen">
        <ng-template>
          <ion-header>
            <ion-toolbar>
              <ion-title>Appointments List</ion-title>
              <ion-buttons slot="end">
                <ion-button (click)="setOpen(false)">Close</ion-button>
              </ion-buttons>
            </ion-toolbar>
          </ion-header>
          <ion-content class="ion-padding">
            <h1>
              {{formatDate(selectedDate)}}
            </h1>
            <ion-button
              *ngIf="selectedDate"
              (click)="toggleDayOff(selectedDate)"
              [color]="daysOff.includes(selectedDate.toISOString().split('T')[0]) ? 'danger' : 'primary'"
            >
              {{ daysOff.includes(selectedDate.toISOString().split('T')[0]) ? 'Mark as Working Day' : 'Mark as Day Off' }}
            </ion-button>
            <ion-list>
              <ng-container *ngIf="selectedDayAppointments.length > 0; else noAppointments">
                <ng-container *ngFor="let appointment of selectedDayAppointments">
                  <ion-item class="calendar-event" [ngClass]="getStatusClass(appointment.status)">
                    <ion-label>
                      <p>
                        Patient: {{ appointment.patient_name }}<br>
                        Time: {{ getTime(appointment.dateTime) }}<br>
                        Status: {{ appointment.status }}
                      </p>
                    </ion-label>
                  </ion-item>
                </ng-container>
              </ng-container>
              <ng-template #noAppointments>
                <ion-item lines="none">
                  <ion-label class="no-appointments">No appointments on this date</ion-label>
                </ion-item>
              </ng-template>
            </ion-list>
          </ion-content>
        </ng-template>
      </ion-modal>
    </ion-content>
  </div>
</ion-content>
